---
title: "8.1.1.6 EKS NAT Gateway 사용"
excerpt: ""
permalink: /docs/ko/8.1.1.6/
redirect_from:
  - /theme-setup/
toc: false
toc_sticky: false
---

---
### EKS NAT Gateway 구성도

    ![EKS-NAT-Gateway]({{ site.baseurl }}/assets/KR/{{ site.version }}/EKS/eks-nat-gateway.png)  
  
참고 : <https://blog.2dal.com/2018/12/31/nat-gateway-to-nat-instance/>  

### Name 규칙  
zone 으로 구분 되는 경우 zone 명칭을 사용 한다.

    * EKS Cluster  name : cocktail-eks-cluster (중복 될수 없다.)
    
    * VPC name : eks-cluster-vpc
  
    * Subnets name :
    
        - availability zone A : Public subnet-<A zone> , Private subnet-<A zone>
    
        - availability zone B : Public subnet-<B zone> , Private subnet-<B zone>

    * Route Tables :
  
        - Public-subnet-rtb
    
        - Private-subnet-<A zone>-rtb , Private-subnet-<B zone>-rtb
    
    * Security Group :
  
        - EKS Control Plane name : <cluster-name>-control-plane-sg
    
        - Work node name : CloudFormation 에서 work node 생성시 자동 생성 됨
    
### 1. VPC 생성

    * Elastic IP address 생성 for NAT Gateway * 2개

    * VPC(name: eks-cluster-vpc) 설정

        1. Run the VPC Wizard

            * VPC Dashboard 클릭 > Launch VPC Wizard 클릭 > VPC with Public and Private Subnets 선택(select)

                a. IPv4 CIDR block: : 10.0.0.0/16 (사용자가 사용 할 CIDR block 구성)

                b. VPC name : eks-cluster-vpc

                c. Public subnet's IPv4 CIDR : 10.0.10.0/24  - example

                d. Availability Zone :  <A zone> 선택

                e. Public subnet name : Public subnet-<A zone>

                --

                f. Private subnet's IPv4 CIDR : 10.0.20.0/24 - example

                g. Availability Zone :  <A zone> - public subnet 과 같은 zone 선택

                h. Private subnet name : Private subnet-<A zone>

                --

                i. Elastic IP Allocation ID : 위에서 생성한 EIP 선택 - NAT Gateway 자동 생성됨

                j. Create VPC 클릭

                ---
        
            참고 : 

                * Public subnet-<A zone> 에 Route table 의 Target 이 internet gateway 으로 자동 설정됨.

                * Private subnet-<A zone> 에 Route table 의 Target 이 Wizard 로 생성된 nat gateway 로 자동 설정됨.
         
        2. Public , Private subnet-<B zone> 을 위의 구성도 처럼 다른존으로 추가 한다.

            a. 참조 : <https://docs.aws.amazon.com/eks/latest/userguide/create-public-private-vpc.html#create-add-subnets>

            b. Subnets 화면에서 Public subnet-<B zone> 선택 > Route Table 탭 선택 > Target 을 Internet gateway 로 설정 한다.

        3. NAT Gateway 추가 생성

            a. Create NAT Gateway 클릭 > Private subnet-<B zone> 선택 > EIP 선택 > create

            b. NAT Gateway ID를 기억한다.

        4. Private subnets Route Tales 설정  
        여기서는 Private-subnet-<A zone>-rtb , Private-subnet-<B zone>-rtb 로 이름을 정한다.

            * 자동 생성된 Route Table(target: nat gateway) 의 Name을 Private-subnet-<A zone>-rtb 으로 설정한다.

            * Create route table 클릭 > name : Private-subnet-<B zone>-rtb > eks-cluster-vpc 선택 > create 추가 생성 한다.

            * Route Table(rtb) 설정

                a. Private-subnet-<A zone>-rtb rtb 선택

                b. Routes 탭에서 Target 확인(Wizad 로 생성된 NAT Gateway)

                c. Subnet Associations 탭에서 > Edit subnet associations > Private subnet-<A zone>( Wizard 로 생성된) 선택

                --

                a. 생성한 private-subnet-<B zone>-rtb 선택

                b. Routes 탭으로 이동 > Edit routes 클릭

                    * Destination : 0.0.0.0/0

                    * Target : NAT Gateway 선택 > 위에서 추가 생성한 NAT Gateway ID 선택

                    * Save routes

                c. Subnet Associations 탭으로 이동 > Edit subnet associations 클릭

                    * Private subnet-<B zone> ( 추가생성한 ) 선택

    * Create a Control Plane Security Group : EKS 보안그룹을 생성 한다.

        * For example, <cluster-name>-control-plane-sg.

### 2. eks cluster 생성

    a. 위에서 생성한 vpc 의 private subnet 만 선택

    b. 위에서 생성한 Security group 선택

    c. API server endpoint access : public and private 모두 Enabled 설정

    d. active 상태 까지 대기 한다 (10분정도 휴식)

### 3. vpc , subnet tag 설정 확인 / 생성

    * 참고 : <https://docs.aws.amazon.com/eks/latest/userguide/network_reqs.html> 

    * **VPC Tagging Requirement (EKS 생성시 VPC에 자동 생성)**  
    When you create your Amazon EKS cluster, Amazon EKS tags the VPC containing the subnets you specify in the following way so that Kubernetes can discover it:

        Key                                  | Value
        ------------------------------------ | ------
        kubernetes.io/cluster/<cluster-name> | shared


    * **Subnet Tagging Requirement(EKS 생성시 private 만 자동 생성됨) - 모든 subnet에 추가**  

    **Note**  
    All subnets (**public and private**) that your cluster uses for resources should have this tag.

        Key                                  | Value
        ------------------------------------ | ------
        kubernetes.io/cluster/<cluster-name> | shared

    * **Private Subnet Tagging Requirement for Internal Load Balancers**  
    Private subnets in your VPC should be tagged accordingly so that Kubernetes knows that it can use them for internal load balancers:

        Key                             | Value
        ------------------------------- | ----
        kubernetes.io/role/internal-elb | 1

    * **Public Subnet Tagging Option for External Load Balancers**  
    Public subnets in your VPC may be tagged accordingly so that Kubernetes knows to use only those subnets for external load balancers, instead of choosing a public subnet in each Availability Zone (in lexicographical order by subnet ID):

        Key                    | Value
        ---------------------- | ----
        kubernetes.io/role/elb | 1

